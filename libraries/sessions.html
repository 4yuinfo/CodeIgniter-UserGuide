<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Session 類別 : CodeIgniter 使用手冊</title>

<style type='text/css' media='all'>@import url('../userguide.css');</style>
<link rel='stylesheet' type='text/css' media='all' href='../userguide.css' />

<script type="text/javascript" src="../nav/nav.js"></script>
<script type="text/javascript" src="../nav/prototype.lite.js"></script>
<script type="text/javascript" src="../nav/moo.fx.js"></script>
<script type="text/javascript" src="../nav/user_guide_menu.js"></script>

<meta http-equiv='expires' content='-1' />
<meta http-equiv= 'pragma' content='no-cache' />
<meta name='robots' content='all' />
<meta name='author' content='ExpressionEngine Dev Team' />
<meta name='description' content='CodeIgniter 使用手冊' />

</head>
<body>

<!-- START NAVIGATION -->
<div id="nav"><div id="nav_inner"><script type="text/javascript">create_menu('../');</script></div></div>
<div id="nav2"><a name="top"></a><a href="javascript:void(0);" onclick="myHeight.toggle();"><img src="../images/nav_toggle_darker.jpg" width="154" height="43" border="0" title="Toggle 目錄" alt="Toggle 目錄" /></a></div>
<div id="masthead">
<table cellpadding="0" cellspacing="0" border="0" style="width:100%">
<tr>
<td><h1>CodeIgniter 使用手冊 Version 1.7.2</h1></td>
<td id="breadcrumb_right"><a href="../toc.html">目錄</a></td>
</tr>
</table>
</div>
<!-- END NAVIGATION -->


<!-- START BREADCRUMB -->
<table cellpadding="0" cellspacing="0" border="0" style="width:100%">
<tr>
<td id="breadcrumb">
<a href="http://ci.wuboy.twbbs.org/">CodeIgniter 首頁</a> &nbsp;&#8250;&nbsp;
<a href="../index.html">使用手冊首頁</a> &nbsp;&#8250;&nbsp;
Session 類別
</td>
<td id="searchbox"><form method="get" action="http://www.google.com/search"><input type="hidden" name="as_sitesearch" id="as_sitesearch" value="ci.wuboy.twbbs.org/user_guide/" />搜尋使用手冊&nbsp; <input type="text" class="input" style="width:200px;" name="q" id="q" size="31" maxlength="255" value="" />&nbsp;<input type="submit" class="submit" name="sa" value="Go" /></form></td>
</tr>
</table>
<!-- END BREADCRUMB -->

<br clear="all" />


<!-- START CONTENT -->
<div id="content">


<h1>Session 類別</h1>

<p>Session類別允許你在使用者瀏覽你的網頁時，保存使用者的"狀態"及紀錄使用者活動。Session類別將每個使用者的session資訊序列化
（並可經過加密）後，儲存在cookie中。除此之外，亦可將session資料儲存於資料庫表格中，藉由比對使用者cookie中所儲存的session id
是否與資料庫中的id符合，來增強其安全性。Session類別預設僅將session儲存於cookie當中，若要使用資料庫來儲存，必須依照下面指示的
方式來建立session表格。</p>

<p class="important"><strong>注意:</strong> CI的Session類別採用自己建立的session資料，<strong>而非</strong> PHP所提供的
session，藉此為開發者提供更佳的彈性。</p>

<h2>初始化Session</h2>

<p>基本上，session會在每個頁面載入後，以全域的方式運行。Session類別可利用<a href="../general/controllers.html">控制器</a>的
建構子作<a href="../general/libraries.html">初始化</a>，抑或是利用系統的<a href="../general/autoloader.html">自動載入</a>
機制（譯注：即application/config/autoload.php檔）。大部分的情形下，session載入後便會在背景運行，因此初始化之後，session的資
料便會自動被讀取、建立及更新。</p>


<p>若要在控制器的建構子裡手動初始化Session類別，可使用<dfn>$this->load->library</dfn>函數：</p>

<code>$this->load->library('session');</code>
<p>一旦類別被載入，便可透過<dfn>$this->session</dfn>的方式來存取Session物件</p>


<h2>Session如何運作？</h2>

<p>當一頁面被載入時，session類別會檢查使用者的cookie檔是否存在有效的session資料。若是<strong>不</strong>存在（或是已經過期）
，則會建立一新session並儲存於cookie中；若是存在，則該session的資訊與其cookie皆會同時被更新。而每次更新時，session_id亦會重
新被產生。</p>

<p>對於使用者來說，非常重要且需要了解的一點是，Session類別一旦被初始化後，便會自動運作，使用者無需理會接下來的任何事情。如同
下面所示，你可任意使用，甚至新增自己的session資料。而在此過程中，讀取、寫入以及更新session等動作都是自動完成的。</p>


<h2>Session資料是什麼？</h2>

<p>就CodeIgniter而言，一個<em>session</em>是由包含下列資訊的陣列所組成。</p>

<ul>
<li>單一且不重複的使用者Session ID（此為一統計意義上具極大亂度(entropy)的隨機字串。為具備可移植性，採MD5演算法作雜湊運算，且預設每五分鐘重新產生一次）</li>
<li>使用者的IP位址</li>
<li>用戶瀏覽器的User Agent資料（取前50個字元）</li>
<li>"上次活動"時間戳記</li>
</ul>

<p>上述資料以下列的陣列格式序列化並儲存至cookie中：</p>

<code>[array]<br />
(<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'session_id'&nbsp;&nbsp;&nbsp;&nbsp;=> random hash,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'ip_address'&nbsp;&nbsp;&nbsp;&nbsp;=> 'string - user IP address',<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_agent'&nbsp;&nbsp;&nbsp;&nbsp;=> 'string - user agent data',<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'last_activity' => timestamp<br />
)</code>

<p>If you have the encryption option enabled，the serialized array will be encrypted before being stored in the cookie,
making the data highly secure and impervious to being read or altered by someone. More info regarding encryption
can be <a href="encryption.html">found here</a>，although the Session class will take care of initializing
and encrypting the data automatically.</p>

<p>注意: Session cookies are only updated every five minutes by default to reduce processor load.  If you repeatedly reload a page
you'll notice that the "last activity" time only updates if five minutes or more has passed since the last time
the cookie was written. This time is configurable by changing the $config['time_to_update'] line in your system/config/config.php file.</p>

<h2>Retrieving Session Data</h2>

<p>Any piece of information from the session array is available using the following function:</p>

<code>$this->session->userdata('<samp>item</samp>');</code>

<p>Where <samp>item</samp> is the array index corresponding to the item you wish to fetch.  For example，to fetch the session ID you
will do this:</p>

<code>$session_id = $this->session->userdata('<samp>session_id</samp>');</code>

<p><strong>注意:</strong> The function returns FALSE (boolean) if the item you are trying to access does not exist.</p>


<h2>Adding Custom Session Data</h2>

<p>A useful aspect of the session array is that you can add your own data to it and it will be stored in the user's cookie.
Why would you want to do this?  Here's one 參考範例:</p>

<p>Let's say a particular user logs into your site. Once authenticated,
you could add their username and email address to the session cookie，making that data globally available to you without
having to run a database query when you need it.</p>

<p>To add your data to the session array involves passing an array containing your new data to this function:</p>

<code>$this->session->set_userdata(<samp>$array</samp>);</code>

<p>Where <samp>$array</samp> is an associative array containing your new data.  Here's an 參考範例:</p>


<p><code>$newdata = array(<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'username'&nbsp; => 'johndoe',<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'email'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=> 'johndoe@some-site.com',<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'logged_in' => TRUE<br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />
	<br />
	$this->session->set_userdata(<samp>$newdata</samp>);</code></p>
<p>If you want to add userdata one value at a time，set_userdata() also supports this syntax. </p>
<p><code>$this-&gt;session-&gt;set_userdata('some_name'，'some_value');</code></p>
<p class="important"><strong>注意:</strong> Cookies can only hold 4KB of data，so be careful not to exceed the capacity.  The
encryption process in particular produces a longer data string than the original so keep careful track of how much data you are storing.</p>

<h2>Removing Session Data</h2>
<p>Just as set_userdata() can be used to add information into a session，unset_userdata() can be used to remove it，by passing the session key. For example，if you wanted to remove 'some_name' from your session information: </p>
<p><code>$this-&gt;session-&gt;unset_userdata('some_name');</code></p>
<p>This function can also be passed an associative array of items to unset.</p>
<p><code>$array_items = array('username' => ''，'email' => '');<br />
<br />
$this-&gt;session-&gt;unset_userdata(<samp>$array_items</samp>);</code></p>
<h2>Flashdata</h2>
<p>CodeIgniter supports &quot;flashdata&quot;，or session data that will only be available for the next server request，and are then automatically cleared. These can be very useful，and are typically used for informational or status messages (for 參考範例: &quot;record 2 deleted&quot;).</p>
<p>注意: Flash variables are prefaced with &quot;flash_&quot; so avoid this prefix in your own session names.</p>
<p>To add flashdata:</p>
<p><code>$this-&gt;session-&gt;set_flashdata('item'，'value');</code></p>
<p>You can also pass an array to set_flashdata()，in the same manner as set_userdata(). </p>
<p>To read a flashdata variable:</p>
<p><code>$this-&gt;session-&gt;flashdata('item');</code></p>
<p>If you find that you need to preserve a flashdata variable through an additional request，you can do so using the keep_flashdata() function.</p>
<p><code>$this-&gt;session-&gt;keep_flashdata('item');</code></p>
<h2>Saving Session Data to a Database</h2>
<p>While the session data array stored in the user's cookie contains a Session ID,
unless you store session data in a database there is no way to validate it.  For some applications that require little or no
security，session ID validation may not be needed，but if your application requires security，validation is mandatory.</p>

<p>When session data is available in a database，every time a valid session is found in the user's cookie，a database
query is performed to match it.  If the session ID does not match，the session is destroyed.  Session IDs can never
be updated，they can only be generated when a new session is created.</p>

<p>In order to store sessions，you must first create a database table for this purpose.  Here is the basic
prototype (for MySQL) required by the session class:</p>

<textarea class="textarea" style="width:100%" cols="50" rows="8">
CREATE TABLE IF NOT EXISTS  `ci_sessions` (
session_id varchar(40) DEFAULT '0' NOT NULL,
ip_address varchar(16) DEFAULT '0' NOT NULL,
user_agent varchar(50) NOT NULL,
last_activity int(10) unsigned DEFAULT 0 NOT NULL,
user_data text NOT NULL,
PRIMARY KEY (session_id)
);</textarea>

<p><strong>注意:</strong> By default the table is called <dfn>ci_sessions</dfn>，but you can name it anything you want
as long as you update the <kbd>application/config/config.php</kbd> file so that it contains the name you have chosen.
Once you have created your database table you can enable the database option in your config.php file as follows:</p>

<code>$config['sess_use_database'] = TRUE;</code>

<p>Once enabled，the Session class will store session data in the DB.</p>

<p>Make sure you've specified the table name in your config file as well:</p>

<code>$config['sess_table_name'] = 'ci_sessions";</code>

<p class="important"><strong>注意:</strong> The Session class has built-in garbage collection which clears out expired sessions so you
do not need to write your own routine to do it.</p>


<h2>Destroying a Session </h2>
<p>To clear the current session: </p>
<code>$this-&gt;session-&gt;sess_destroy();</code>
<p class="important"><strong>注意:</strong> This function should be the last one called，and even flash variables will no longer be available.  If you only want some items destroyed and not all，use <dfn>unset_userdata()</dfn>.</p>



<h2>Session Preferences</h2>
<p>You'll find the following Session related preferences in your <kbd>application/config/config.php</kbd> file:</p>


<table cellpadding="0" cellspacing="1" border="0" style="width:100%" class="tableborder">
<tr>
	<th>Preference</th>
	<th>Default</th>
	<th>Options</th>
	<th>Description</th>
</tr>
<tr>
	<td class="td"><strong>sess_cookie_name</strong></td>
	<td class="td">ci_session</td>
	<td class="td">None</td>
	<td class="td">The name you want the session cookie saved as.</td>
</tr>
<tr>
	<td class="td"><strong>sess_expiration</strong></td>
	<td class="td">7200</td>
	<td class="td">None</td>
	<td class="td">The number of seconds you would like the session to last. The default value is 2 hours (7200 seconds). If you would like a non-expiring session set the value to zero: 0</td>
</tr>
<tr>
	<td class="td"><strong>sess_encrypt_cookie</strong></td>
	<td class="td">FALSE</td>
	<td class="td">TRUE/FALSE (boolean)</td>
	<td class="td">Whether to encrypt the session data.</td>
</tr>
<tr>
	<td class="td"><strong>sess_use_database</strong></td>
	<td class="td">FALSE</td>
	<td class="td">TRUE/FALSE (boolean)</td>
	<td class="td">Whether to save the session data to a database.  You must create the table before enabling this option.</td>
</tr>
<tr>
	<td class="td"><strong>sess_table_name</strong></td>
	<td class="td">ci_sessions</td>
	<td class="td">Any valid SQL table name</td>
	<td class="td">The name of the session database table.</td>
</tr>
<tr>
	<td class="td"><strong>sess_time_to_update</strong></td>
	<td class="td">300</td>
	<td class="td">Time in seconds</td>
	<td class="td">This options controls how often the session class will regenerate itself and create a new session id.</td>
</tr>
<tr>
	<td class="td"><strong>sess_match_ip</strong></td>
	<td class="td">FALSE</td>
	<td class="td">TRUE/FALSE (boolean)</td>
	<td class="td">Whether to match the user's IP address when reading the session data.  Note that some ISPs dynamically
	changes the IP，so if you want a non-expiring session you will likely set this to FALSE.</td>
</tr>
<tr>
	<td class="td"><strong>sess_match_useragent</strong></td>
	<td class="td">TRUE</td>
	<td class="td">TRUE/FALSE (boolean)</td>
	<td class="td">Whether to match the User Agent when reading the session data.</td>
</tr>
</table>


</div>
<!-- END CONTENT -->


<div id="footer">
<p>
上個主題:&nbsp;&nbsp;<a href="pagination.html">Pagination 類別</a>
&nbsp;&nbsp;&nbsp;&middot;&nbsp;&nbsp;
<a href="#top">頁首</a>&nbsp;&nbsp;&nbsp;&middot;&nbsp;&nbsp;
<a href="../index.html">使用手冊首頁</a>&nbsp;&nbsp;&nbsp;&middot;&nbsp;&nbsp;
下個主題:&nbsp;&nbsp;<a href="trackback.html">Trackback 類別</a>
</p>
<p><a href="http://ci.wuboy.twbbs.org">CodeIgniter</a> &nbsp;&middot;&nbsp; Copyright &#169; 2006-2009 &nbsp;&middot;&nbsp; <a href="http://ellislab.com/">Ellislab，Inc.</a></p>
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-5766319-11");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
